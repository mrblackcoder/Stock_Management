# =============================================================================
# Stock Management System - Production Docker Compose
# For AWS ECS deployment with external RDS
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # Backend Application (Spring Boot)
  # ===========================================================================
  backend:
    image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG:-latest}
    container_name: inventory-backend
    restart: unless-stopped
    environment:
      # Spring Profile
      SPRING_PROFILES_ACTIVE: prod

      # Database Configuration (AWS RDS)
      DB_URL: ${DB_URL}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}

      # JWT Configuration (AWS Secrets Manager)
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-900000}

      # Admin Configuration
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

      # CORS Configuration
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}

      # Swagger (disabled in prod)
      SWAGGER_ENABLED: "false"

      # Java Options for containers
      JAVA_OPTS: >-
        -XX:+UseContainerSupport
        -XX:MaxRAMPercentage=75.0
        -XX:InitialRAMPercentage=50.0
        -Djava.security.egd=file:/dev/./urandom
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: awslogs
      options:
        awslogs-group: /ecs/stock-management
        awslogs-region: ${AWS_REGION:-us-east-1}
        awslogs-stream-prefix: backend

  # ===========================================================================
  # Frontend Application (Nginx)
  # ===========================================================================
  frontend:
    image: ${ECR_REGISTRY}/${ECR_FRONTEND_REPOSITORY}:${IMAGE_TAG:-latest}
    container_name: inventory-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: awslogs
      options:
        awslogs-group: /ecs/stock-management
        awslogs-region: ${AWS_REGION:-us-east-1}
        awslogs-stream-prefix: frontend
